version: '3'

vars:
  COMPONENT:
    sh: cat go.mod | head -1 | cut -d \  -f2 | cut -d / -f 3

tasks:
  default:
    cmds:
      - task: lint
      - task: tests

  lint:
    cmds:
    - golangci-lint run -v --fix

  tests:
    cmds:
    - go test ./...

  build:
    cmds:
    - go build

  build-image:
    cmds:
    - docker build -t github.com/formancehq/{{.COMPONENT}} .

  run-image:
    deps:
    - build-image
    cmds:
    - docker run --rm github.com/formancehq/{{.COMPONENT}}

  generate-client:
  - >
    docker run --rm 
    -w /local 
    -v ${PWD}:/local 
    openapitools/openapi-generator-cli:latest generate 
    -i swagger.yaml 
    -g go 
    -o ./authclient 
    --git-user-id=formancehq 
    --git-repo-id=auth 
    -p packageVersion=latest 
    -p isGoSubmodule=true 
    -p packageName=authclient

  install-deps-demo-client:
    cmds:
      - cd demo && rm package-lock.json && yarn install
